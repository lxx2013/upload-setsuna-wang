<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>upload</title>
  <link rel="stylesheet" href="./assets/main.css">
</head>

<body>
  <div class="main">
    <div class="area" id="fileDragArea">
      <div><span>Drag & drop files here ...</span></div>
    </div>
    <div class="button"><span class="folder-open">添加文件</span><span class="folder-open">确认上传</span></div>
  </div>
  <form id="uploadForm" action="../upload">
    <input id="fileImage" type='file' multiple />
  </form>
</body>

<script src="./assets/ZXXFILE.js"></script>
<script>
  var $ = document.querySelector.bind(document);
  var $$ = document.querySelectorAll.bind(document);
  $('.folder-open').onclick = () => {
    $('#fileImage').click();
  }
  var params = {
    fileInput: $("#fileImage"),
    dragDrop: $("#fileDragArea"),
    upButton: $("#fileSubmit"),
    url: $("#uploadForm").getAttribute("action"),
    filter: function (files) {
      var arrFiles = [];
      for (var i = 0, file; file = files[i]; i++) {
        console.log(`第${i}个文件: ${file.name} 文件MIME为: ${file.type}`);
        arrFiles.push(file);
      }
      return arrFiles;
    },
    onSelect: function (files) {
      var html = '', i = 0;
      $("#preview").html('<div class="upload_loading"></div>');
      var funAppendImage = function () {
        file = files[i];
        if (file) {
          var reader = new FileReader()
          reader.onload = function (e) {
            html = html + '<div id="uploadList_' + i + '" class="upload_append_list"><p><strong>' + file.name + '</strong>' +
              '<a href="javascript:" class="upload_delete" title="删除" data-index="' + i + '">删除</a><br />' +
              '<img id="uploadImage_' + i + '" src="' + e.target.result + '" class="upload_image" /></p>' +
              '<span id="uploadProgress_' + i + '" class="upload_progress"></span>' +
              '</div>';

            i++;
            funAppendImage();
          }
          reader.readAsDataURL(file);
        } else {
          $("#preview").html(html);
          if (html) {
            //删除方法
            $(".upload_delete").click(function () {
              ZXXFILE.funDeleteFile(files[parseInt($(this).attr("data-index"))]);
              return false;
            });
            //提交按钮显示
            $("#fileSubmit").show();
          } else {
            //提交按钮隐藏
            $("#fileSubmit").hide();
          }
        }
      };
      funAppendImage();
    },
    onDelete: function (file) {
      $("#uploadList_" + file.index).fadeOut();
      $('#uploadForm')[0].reset();
    },
    onDragOver: function () {
      $(this).addClass("upload_drag_hover");
    },
    onDragLeave: function () {
      $(this).removeClass("upload_drag_hover");
    },
    onProgress: function (file, loaded, total) {
      var eleProgress = $("#uploadProgress_" + file.index), percent = (loaded / total * 100).toFixed(2) + '%';
      eleProgress.show().html(percent);
    },
    onSuccess: function (file, response) {
      $("#uploadInf").append("<p>上传成功，图片地址是：" + response + "</p>");
    },
    onFailure: function (file) {
      $("#uploadInf").append("<p>图片" + file.name + "上传失败！</p>");
      $("#uploadImage_" + file.index).css("opacity", 0.2);
    },
    onComplete: function () {
      //提交按钮隐藏
      $("#fileSubmit").hide();
      //file控件value置空
      $('#uploadForm')[0].reset();
      // 成功提示
      $("#uploadInf").append("<p>当前图片全部上传完毕，可继续添加上传。</p>");
    }
  };
  $.extend = function (origin, options) {
    for (var i in options) {
      origin[i] = options[i];
    }
    return origin;
  }
  ZXXFILE = $.extend(ZXXFILE, params);
  ZXXFILE.init();
</script>

</html>