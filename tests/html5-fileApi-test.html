<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>upload-test</title>
  <style>
    .title{
      font-size: 40px;
      font-family:"Segoe UI","Source Sans Pro",Calibri,Candara,Arial,sans-serif;
      font-weight: 200;
      line-height: 1.1;
      color: #333333;
      margin:10.5px 0;
    }
    .area{
      width:70%;
      border : 1px solid grey;
      border-radius: 5px;
      padding: 5%;
    }
    .area div{
        border:1px dotted grey;
        font-size:0;
        vertical-align: middle;
        text-align: center;
    }
    .area div span{
      display: inline-block;
      padding:15vw 5vw;
      font-size: 25px;
      color : grey;
    }
    .folder-open{
      display: inline-block;
      color:white;
      background-color: #2780e3;
      border-color: #2780e3;
      padding:10px 18px;
      margin:10px 0 0 10px;
      font-family: "Segoe UI";
      font-size: 15px;
    }
    .folder-open:hover{
      background-color: #1967be;
      border-color: #1862b5;
    }
    #fileImage{
      display:none;
    }
  </style>
</head>

<body>
  <div class="title">Image Upload</div>
  <div class="area" id="fileDragArea">
    <div><span>Drag & drop files here ...</span></div>
  </div>
  <div class="folder-open">
      添加文件
  </div> 
  
  <button id="fileSubmit" class="folder-open">确认上传</button>
  <form action="../upload">
    <input id="fileImage" type='file' multiple/>
  </form>
</body>

<script>
  var $  = document.querySelector.bind(document);
  var $$ = document.querySelectorAll.bind(document);
  $('.folder-open').onclick = ()=>{
    $('#fileImage').click();
  }
  var self = {
      fileInput: $("#fileImage"),
      dragDrop: $("#fileDragArea"),
      upButton: $("#fileSubmit"),
      url: '../upload',
      fileFilter: [],					//过滤后的文件数组
      filter: function(files) {		//选择文件组的过滤方法
          return files;	
      },
      onSelect: function() {},		//文件选择后
      onDelete: function() {},		//文件删除后
      onDragOver: function() {},		//文件拖拽到敏感区域时
      onDragLeave: function() {},	//文件离开到敏感区域时
      onProgress: function() {},		//文件上传进度
      onSuccess: function() {console.log('Success!')},		//文件上传成功时
      onFailure: function() {console.log('Failture!')},		//文件上传失败时,
      onComplete: function() {console.log('Complete!')},		//文件全部上传完毕时
      //
      funDeleteFile: ()=>{}
  }
  //文件选择控件选择
  if (self.fileInput) {
    self.fileInput.addEventListener("change", function(e) { self.funGetFiles(e); }, false);	
  }
  self.funGetFiles = (e)=>{
    // 获取文件列表对象
    var files = e.target.files || e.dataTransfer.files;
        //继续添加文件
        self.fileFilter = self.fileFilter.concat(self.filter(files));
        console.log(self.fileFilter);
        //self.funDealFiles();
        return self;
  };
  //上传按钮提交
  if (self.upButton) {
      self.upButton.addEventListener("click", function(e) { self.funUploadFile(e); }, false);	
  } 
  self.funUploadFile = (e)=>{
    for (var i = 0, file; i< self.fileFilter[0].length ; i++) {
        file = self.fileFilter[0][i]
        ;(function(file) {
            var xhr = new XMLHttpRequest();
            if (xhr.upload) {
                // 上传中
                xhr.upload.addEventListener("progress", function(e) {
                    self.onProgress(file, e.loaded, e.total);
                }, false);
                // 文件上传成功或是失败
                xhr.onreadystatechange = function(e) {
                    if (xhr.readyState == 4) {
                        if (xhr.status == 200) {
                            self.onSuccess(file, xhr.responseText);
                            self.funDeleteFile(file);
                            if (!self.fileFilter.length) {
                                //全部完毕
                                self.onComplete();	
                            }
                        } else {
                            self.onFailure(file, xhr.responseText);		
                        }
                    }
                };
                // 开始上传
                xhr.open("POST", self.url, true);
                xhr.setRequestHeader("FILENAME", encodeURIComponent(file.name));
                xhr.send(file);
            }	
        })(file);	
    }	
  }

  
  
</script>

</html>